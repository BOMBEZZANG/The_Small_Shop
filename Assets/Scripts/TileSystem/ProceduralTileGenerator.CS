using UnityEngine;
using UnityEngine.Tilemaps;
#if UNITY_EDITOR
using UnityEditor;
using System.IO;
#endif

public class ProceduralTileGenerator : MonoBehaviour
{
#if UNITY_EDITOR
    [MenuItem("Tools/Tilemap System/Generate Prototype Tiles")]
    public static void GenerateAllPrototypeTiles()
    {
        // í´ë” ìƒì„±
        string spritePath = "Assets/Sprites/GeneratedTiles";
        string tilePath = "Assets/ScriptableObjects/GeneratedTiles";
        
        if (!AssetDatabase.IsValidFolder(spritePath))
        {
            AssetDatabase.CreateFolder("Assets/Sprites", "GeneratedTiles");
        }
        
        if (!AssetDatabase.IsValidFolder(tilePath))
        {
            AssetDatabase.CreateFolder("Assets/ScriptableObjects", "GeneratedTiles");
        }
        
        // ê° íƒ€ì¼ íƒ€ì…ë³„ë¡œ ìƒì„±
        GenerateGroundTiles(spritePath, tilePath);
        GenerateBuildingTiles(spritePath, tilePath);
        GenerateNatureTiles(spritePath, tilePath);
        GenerateSpecialTiles(spritePath, tilePath);
        
        AssetDatabase.SaveAssets();
        AssetDatabase.Refresh();
        
        Debug.Log("í”„ë¡œí† íƒ€ì… íƒ€ì¼ ìƒì„± ì™„ë£Œ!");
    }
    
    static void GenerateGroundTiles(string spritePath, string tilePath)
    {
        // ì”ë””
        CreateColoredTile("Grass", new Color(0.2f, 0.8f, 0.2f), spritePath, tilePath);
        
        // ê¸¸
        CreatePatternTile("Path", new Color(0.6f, 0.5f, 0.3f), TilePattern.Cross, spritePath, tilePath);
        
        // ëŒë°”ë‹¥
        CreatePatternTile("Stone", Color.gray, TilePattern.Brick, spritePath, tilePath);
        
        // ê´‘ì¥
        CreatePatternTile("Plaza", new Color(0.9f, 0.9f, 0.8f), TilePattern.Checkered, spritePath, tilePath);
        
        // ë¬¼
        CreatePatternTile("Water", new Color(0.2f, 0.5f, 0.9f, 0.8f), TilePattern.Wave, spritePath, tilePath);
    }
    
    static void GenerateBuildingTiles(string spritePath, string tilePath)
    {
        // ë²½
        CreatePatternTile("Wall", new Color(0.4f, 0.3f, 0.2f), TilePattern.Brick, spritePath, tilePath);
        
        // í”Œë ˆì´ì–´ ì§‘
        CreateBuildingTile("PlayerHouse", Color.blue, "P", spritePath, tilePath);
        
        // ì¼ë°˜ ì§‘ë“¤
        CreateBuildingTile("House1", new Color(0.8f, 0.6f, 0.4f), "H1", spritePath, tilePath);
        CreateBuildingTile("House2", new Color(0.7f, 0.5f, 0.3f), "H2", spritePath, tilePath);
        
        // ìƒì 
        CreateBuildingTile("Shop", Color.yellow, "S", spritePath, tilePath);
        
        // ê¸¸ë“œ
        CreateBuildingTile("Guild", Color.magenta, "G", spritePath, tilePath);
        
        // ì´Œì¥ ì§‘
        CreateBuildingTile("ChiefHouse", Color.red, "C", spritePath, tilePath);
        
        // ë¬¸
        CreateIconTile("Door", new Color(0.5f, 0.3f, 0.1f), "â–¯", spritePath, tilePath);
    }
    
    static void GenerateNatureTiles(string spritePath, string tilePath)
    {
        // ë‚˜ë¬´ë“¤
        CreateIconTile("Tree1", new Color(0.1f, 0.6f, 0.1f), "ğŸŒ²", spritePath, tilePath);
        CreateIconTile("Tree2", new Color(0.2f, 0.5f, 0.1f), "ğŸŒ³", spritePath, tilePath);
        CreateIconTile("TreeBorder", new Color(0.1f, 0.4f, 0.1f), "T", spritePath, tilePath);
        
        // ê½ƒë“¤
        CreateIconTile("Flower1", Color.red, "âœ¿", spritePath, tilePath);
        CreateIconTile("Flower2", Color.yellow, "â€", spritePath, tilePath);
        CreateIconTile("Flower3", new Color(1f, 0.5f, 0f), "âœ¾", spritePath, tilePath);
        
        // ì‘ë¬¼
        CreateIconTile("Crops", new Color(0.8f, 0.7f, 0.3f), "â–¦", spritePath, tilePath);
    }
    
    static void GenerateSpecialTiles(string spritePath, string tilePath)
    {
        // ë¶„ìˆ˜ëŒ€
        CreateIconTile("Fountain", Color.cyan, "â—‰", spritePath, tilePath);
        CreateIconTile("FountainCenter", new Color(0.3f, 0.6f, 0.9f), "ğŸ’§", spritePath, tilePath);
        
        // í€˜ìŠ¤íŠ¸ ê²Œì‹œíŒ
        CreateIconTile("QuestBoard", new Color(0.6f, 0.4f, 0.2f), "!", spritePath, tilePath);
    }
    
    // ë‹¨ìƒ‰ íƒ€ì¼ ìƒì„±
    static void CreateColoredTile(string name, Color color, string spritePath, string tilePath)
    {
        Texture2D texture = new Texture2D(32, 32);
        Color[] pixels = new Color[32 * 32];
        
        // í…Œë‘ë¦¬ íš¨ê³¼
        for (int y = 0; y < 32; y++)
        {
            for (int x = 0; x < 32; x++)
            {
                if (x == 0 || x == 31 || y == 0 || y == 31)
                {
                    pixels[y * 32 + x] = color * 0.7f; // ë” ì–´ë‘ìš´ í…Œë‘ë¦¬
                }
                else
                {
                    pixels[y * 32 + x] = color;
                }
            }
        }
        
        texture.SetPixels(pixels);
        texture.Apply();
        texture.filterMode = FilterMode.Point;
        
        SaveTileAssets(texture, name, spritePath, tilePath);
    }
    
    // íŒ¨í„´ íƒ€ì¼ ìƒì„±
    static void CreatePatternTile(string name, Color color, TilePattern pattern, string spritePath, string tilePath)
    {
        Texture2D texture = new Texture2D(32, 32);
        Color[] pixels = new Color[32 * 32];
        Color darkColor = color * 0.7f;
        
        for (int y = 0; y < 32; y++)
        {
            for (int x = 0; x < 32; x++)
            {
                switch (pattern)
                {
                    case TilePattern.Checkered:
                        pixels[y * 32 + x] = ((x / 16) + (y / 16)) % 2 == 0 ? color : darkColor;
                        break;
                        
                    case TilePattern.Brick:
                        bool isBrickLine = y % 8 == 0;
                        bool isBrickColumn = (x + ((y / 8) % 2) * 16) % 16 == 0;
                        pixels[y * 32 + x] = (isBrickLine || isBrickColumn) ? darkColor : color;
                        break;
                        
                    case TilePattern.Cross:
                        bool isCross = (x >= 14 && x <= 17) || (y >= 14 && y <= 17);
                        pixels[y * 32 + x] = isCross ? darkColor : color;
                        break;
                        
                    case TilePattern.Wave:
                        float wave = Mathf.Sin(x * 0.3f + y * 0.1f) * 0.5f + 0.5f;
                        pixels[y * 32 + x] = Color.Lerp(darkColor, color, wave);
                        break;
                        
                    default:
                        pixels[y * 32 + x] = color;
                        break;
                }
            }
        }
        
        texture.SetPixels(pixels);
        texture.Apply();
        texture.filterMode = FilterMode.Point;
        
        SaveTileAssets(texture, name, spritePath, tilePath);
    }
    
    // ê±´ë¬¼ íƒ€ì¼ ìƒì„± (ìƒ‰ìƒ + í…ìŠ¤íŠ¸)
    static void CreateBuildingTile(string name, Color color, string text, string spritePath, string tilePath)
    {
        Texture2D texture = new Texture2D(32, 32);
        Color[] pixels = new Color[32 * 32];
        
        // ë°°ê²½ìƒ‰
        for (int i = 0; i < pixels.Length; i++)
        {
            pixels[i] = color;
        }
        
        // ì§€ë¶• íš¨ê³¼ (ìƒë‹¨ 1/3)
        for (int y = 21; y < 32; y++)
        {
            for (int x = 0; x < 32; x++)
            {
                pixels[y * 32 + x] = color * 0.7f;
            }
        }
        
        // ë¬¸ í‘œì‹œ (í•˜ë‹¨ ì¤‘ì•™)
        for (int y = 0; y < 8; y++)
        {
            for (int x = 12; x < 20; x++)
            {
                pixels[y * 32 + x] = Color.black;
            }
        }
        
        texture.SetPixels(pixels);
        texture.Apply();
        texture.filterMode = FilterMode.Point;
        
        SaveTileAssets(texture, name, spritePath, tilePath);
    }
    
    // ì•„ì´ì½˜ íƒ€ì¼ ìƒì„±
    static void CreateIconTile(string name, Color color, string icon, string spritePath, string tilePath)
    {
        Texture2D texture = new Texture2D(32, 32);
        Color[] pixels = new Color[32 * 32];
        
        // ë°°ê²½
        Color bgColor = new Color(color.r * 0.3f, color.g * 0.3f, color.b * 0.3f, 0.5f);
        for (int i = 0; i < pixels.Length; i++)
        {
            pixels[i] = bgColor;
        }
        
        // ì¤‘ì•™ì— ì›í˜• ì•„ì´ì½˜ ì˜ì—­
        Vector2 center = new Vector2(16, 16);
        float radius = 12;
        
        for (int y = 0; y < 32; y++)
        {
            for (int x = 0; x < 32; x++)
            {
                float distance = Vector2.Distance(new Vector2(x, y), center);
                if (distance <= radius)
                {
                    pixels[y * 32 + x] = color;
                }
                else if (distance <= radius + 1)
                {
                    pixels[y * 32 + x] = color * 0.7f; // í…Œë‘ë¦¬
                }
            }
        }
        
        texture.SetPixels(pixels);
        texture.Apply();
        texture.filterMode = FilterMode.Point;
        
        SaveTileAssets(texture, name, spritePath, tilePath);
    }
    
    // í…ìŠ¤ì²˜ë¥¼ ìŠ¤í”„ë¼ì´íŠ¸ì™€ íƒ€ì¼ ì—ì…‹ìœ¼ë¡œ ì €ì¥
    static void SaveTileAssets(Texture2D texture, string name, string spritePath, string tilePath)
    {
        // PNGë¡œ ì €ì¥
        byte[] pngData = texture.EncodeToPNG();
        string pngPath = $"{spritePath}/{name}_Tile.png";
        File.WriteAllBytes(pngPath, pngData);
        
        AssetDatabase.ImportAsset(pngPath);
        
        // ìŠ¤í”„ë¼ì´íŠ¸ ì„¤ì •
        TextureImporter importer = AssetImporter.GetAtPath(pngPath) as TextureImporter;
        if (importer != null)
        {
            importer.spritePixelsPerUnit = 32;
            importer.textureType = TextureImporterType.Sprite;
            importer.filterMode = FilterMode.Point;
            importer.textureCompression = TextureImporterCompression.Uncompressed;
            importer.SaveAndReimport();
        }
        
        // Tile ì—ì…‹ ìƒì„±
        Sprite sprite = AssetDatabase.LoadAssetAtPath<Sprite>(pngPath);
        if (sprite != null)
        {
            Tile tileAsset = ScriptableObject.CreateInstance<Tile>();
            tileAsset.sprite = sprite;
            
            string tileAssetPath = $"{tilePath}/{name}_Tile.asset";
            AssetDatabase.CreateAsset(tileAsset, tileAssetPath);
        }
        
        // ì„ì‹œ í…ìŠ¤ì²˜ ì‚­ì œ
        DestroyImmediate(texture);
    }
    
    enum TilePattern
    {
        Solid,
        Checkered,
        Brick,
        Cross,
        Wave
    }
    
    // ëª¨ë“  ìƒì„±ëœ íƒ€ì¼ì„ MapDataì— ìë™ ì—°ê²°
    [MenuItem("Tools/Tilemap System/Auto Assign Generated Tiles")]
    public static void AutoAssignGeneratedTiles()
    {
        // FirstVillageMap ì°¾ê¸°
        MapData mapData = AssetDatabase.LoadAssetAtPath<MapData>("Assets/ScriptableObjects/MapData/FirstVillageMap.asset");
        if (mapData == null)
        {
            Debug.LogError("FirstVillageMapì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        
        string tilePath = "Assets/ScriptableObjects/GeneratedTiles";
        
        // ê° íƒ€ì¼ ìë™ í• ë‹¹
        mapData.tileAssets.grassTile = LoadTile(tilePath, "Grass_Tile");
        mapData.tileAssets.pathTile = LoadTile(tilePath, "Path_Tile");
        mapData.tileAssets.stoneTile = LoadTile(tilePath, "Stone_Tile");
        mapData.tileAssets.plazaTile = LoadTile(tilePath, "Plaza_Tile");
        mapData.tileAssets.waterTile = LoadTile(tilePath, "Water_Tile");
        
        mapData.tileAssets.wallTile = LoadTile(tilePath, "Wall_Tile");
        mapData.tileAssets.playerHouseTile = LoadTile(tilePath, "PlayerHouse_Tile");
        mapData.tileAssets.house1Tile = LoadTile(tilePath, "House1_Tile");
        mapData.tileAssets.house2Tile = LoadTile(tilePath, "House2_Tile");
        mapData.tileAssets.shopTile = LoadTile(tilePath, "Shop_Tile");
        mapData.tileAssets.guildTile = LoadTile(tilePath, "Guild_Tile");
        mapData.tileAssets.chiefHouseTile = LoadTile(tilePath, "ChiefHouse_Tile");
        mapData.tileAssets.doorTile = LoadTile(tilePath, "Door_Tile");
        
        mapData.tileAssets.tree1Tile = LoadTile(tilePath, "Tree1_Tile");
        mapData.tileAssets.tree2Tile = LoadTile(tilePath, "Tree2_Tile");
        mapData.tileAssets.flower1Tile = LoadTile(tilePath, "Flower1_Tile");
        mapData.tileAssets.flower2Tile = LoadTile(tilePath, "Flower2_Tile");
        mapData.tileAssets.flower3Tile = LoadTile(tilePath, "Flower3_Tile");
        mapData.tileAssets.cropsTile = LoadTile(tilePath, "Crops_Tile");
        
        mapData.tileAssets.fountainTile = LoadTile(tilePath, "Fountain_Tile");
        mapData.tileAssets.fountainCenterTile = LoadTile(tilePath, "FountainCenter_Tile");
        mapData.tileAssets.questBoardTile = LoadTile(tilePath, "QuestBoard_Tile");
        
        EditorUtility.SetDirty(mapData);
        AssetDatabase.SaveAssets();
        
        Debug.Log("ìƒì„±ëœ íƒ€ì¼ì´ MapDataì— ìë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }
    
    static TileBase LoadTile(string path, string name)
    {
        return AssetDatabase.LoadAssetAtPath<TileBase>($"{path}/{name}.asset");
    }
#endif
}